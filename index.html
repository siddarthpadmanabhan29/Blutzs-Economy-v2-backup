<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blutz Economy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Required CSS for the new Contract UI math boxes */
    :root {
      --contract-bg: #ffffff;
      --contract-text: #2c3e50;
      --contract-border: #dcdde1;
    }

    body.dark-mode {
      --contract-bg: #121212; 
      --contract-text: #f5f6fa;
      --contract-border: #333;
    }

    .contract-inner-box {
      background: rgba(0, 0, 0, 0.05);
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
      border: 1px solid rgba(0,0,0,0.03);
    }

    body.dark-mode .contract-inner-box {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255,255,255,0.05);
    }

    .contract-label {
      display: block;
      font-size: 0.65rem;
      font-weight: 800;
      opacity: 0.7;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .admin-input-adaptive {
      background: var(--contract-bg);
      color: var(--contract-text);
      border: 1px solid var(--contract-border);
    }

    /* Membership CSS */
    .plans-container {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      justify-content: space-between;
      margin-top: 15px;
    }

    .plan-card {
      background: var(--contract-bg);
      border: 1px solid var(--contract-border);
      padding: 15px;
      border-radius: 12px;
      flex: 1;
      min-width: 200px;
      text-align: center;
      transition: transform 0.2s;
    }

    .plan-card:hover { transform: translateY(-3px); }

    .plan-card h4 { margin: 0 0 10px 0; font-size: 1.1em; }
    .plan-price { font-size: 1.2em; font-weight: 800; color: #2ecc71; margin-bottom: 10px; }
    .plan-perks { 
        text-align: left; 
        font-size: 0.8em; 
        list-style: none; 
        padding: 0; 
        margin: 10px 0; 
        opacity: 0.9;
    }
    .plan-perks li { margin-bottom: 5px; display: flex; align-items: flex-start; gap: 5px; }

    /* Contract Notification Bar Animation */
    @keyframes pulse-red {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(0.99); }
      100% { opacity: 1; transform: scale(1); }
    }

    /* Connection Status Dot Animation */
    @keyframes pulse-green {
      0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
      70% { transform: scale(1); box-shadow: 0 0 0 4px rgba(46, 204, 113, 0); }
      100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }
    .status-online { animation: pulse-green 2s infinite; }
    
    /* Chart Container Styling */
    .retirement-chart-container {
      margin-top: 20px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Status Billing Box */
    .billing-status-box {
      background: rgba(46, 204, 113, 0.1);
      border: 1px dashed #2ecc71;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.9em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="login-screen" class="screen">
    <div id="login-form">
      <h1>Login / Register</h1>
      <input id="login-username" placeholder="Username" autocomplete="off">
      <input id="login-password" type="password" placeholder="Password" autocomplete="new-password">
      <button id="login-btn" class="btn-primary" type="button">Login / Register</button>
    </div>
  </div>

  <div id="dashboard" class="screen hidden">
    <header id="dashboard-navbar">
      <div class="navbar-left">
        <span>Welcome, <strong id="user-name"></strong></span>
        <span>Balance: <strong id="user-balance"></strong></span>
        <span style="margin-left: 15px; border-left: 1px solid rgba(255,255,255,0.3); padding-left: 15px;">
          BPS: <strong id="user-bps" style="color: #d1bce3;">0</strong>
        </span>
      </div>
      <div class="navbar-right">
        <button id="open-admin" class="btn-secondary hidden" type="button">Admin Panel</button>
        <button id="logout-btn" class="btn-danger" type="button">Logout</button>
      </div>
    </header>

    <main id="dashboard-content">
      <div id="dashboard-notification-bar"></div>

      <section class="section-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <h3>Profile</h3>
            <button id="theme-toggle-btn" class="btn-secondary cosmetic-feature" data-id="darkMode" type="button">üåô</button>
          </div>
          <div id="connection-indicator" style="display: inline-flex; align-items: center; background: rgba(0,0,0,0.05); padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.05);">
            <span id="status-dot" style="height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 8px;"></span>
            <span id="status-text" style="font-size: 0.65rem; font-weight: 800; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">Connecting</span>
          </div>
        </div>
        
        <p><strong>Username:</strong> <span id="profile-username"></span> <span id="profile-membership-badge"></span></p>
        <p><strong>ID:</strong> <span id="profile-uid"></span></p>
        <p><strong>Renewed On:</strong> <span id="profile-renewal"></span></p>
        <p><strong>Expires On:</strong> <span id="profile-expiration"></span></p>
        <p><strong>Status:</strong> <span id="renewal-status"></span> | 
            <strong>Employment:</strong> <span id="employment-status"></span></p>
        <button id="renew-btn" class="btn-primary" type="button">Request Renewal</button>
      </section>

      <section class="section-card" style="border: 2px solid #2ecc71;">
    <h3 style="color: #2ecc71;">üíé Membership Plans</h3>
    <p style="font-size: 0.85em; opacity: 0.8;">Subscribe for exclusive perks and lower taxes. Auto-renews monthly.</p>
    
    <div id="membership-billing-info" class="billing-status-box hidden"></div>

    <div class="plans-container">
        <div class="plan-card">
            <h4>üü¢ Basic</h4>
            <div class="plan-price">$100,000/Month</div>
            <ul class="plan-perks">
                <li>‚úÖ 8% Shop Tax</li>
                <li>‚úÖ 4% Retirement Interest</li>
                <li>‚úÖ 1% Usage Cashback</li>
                <li>‚úÖ 1 Free Shop Item after every 3 used</li>
                <li>‚úÖ Basic Plan Profile Badge</li>
            </ul>
            <button class="btn-primary join-plan-btn" data-plan="basic">Join Basic</button>
        </div>

        <div class="plan-card" style="border-color: #9b59b6;">
            <h4 style="color: #9b59b6;">üíé Premium</h4>
            <div class="plan-price">$300,000/Month</div>
            <ul class="plan-perks">
                <li>‚úÖ 4% Shop Tax</li>
                <li>‚úÖ 5% Retirement Interest</li>
                <li>‚úÖ 2% Usage Cashback</li>
                <li>‚úÖ 1 Free Shop Item after every 2 used</li>
                <li>‚úÖ Earn 10 BPS per shop purchase</li>
                <li>‚úÖ Premium Plan Profile Badge</li>
            </ul>
            <button class="btn-primary join-plan-btn" data-plan="premium" style="background-color: #9b59b6;">Join Premium</button>
        </div>

        <div class="plan-card" style="border-color: #f1c40f;">
            <h4 style="color: #f1c40f;">üëë Platinum</h4>
            <div class="plan-price">$500,000/Month</div>
            <ul class="plan-perks">
                <li>‚úÖ 0% Shop Tax (Tax Exempt!)</li>
                <li>‚úÖ 5% Retirement Interest</li>
                <li>‚úÖ 3% Usage Cashback</li>
                <li>‚úÖ 1 Free Shop Item after every 1 used</li>
                <li>‚úÖ Earn 20 BPS per shop purchase</li>
                <li>‚úÖ Free Custom Nav Color</li>
                <li>‚úÖ Platinum Plan Profile Badge</li>
            </ul>
            <button class="btn-primary join-plan-btn" data-plan="platinum" style="background-color: #f1c40f;">Join Platinum</button>
        </div>
    </div>

    <div style="text-align: center; margin-top: 15px;">
        <button id="cancel-plan-btn" class="btn-danger hidden" style="font-size: 0.8em;">Cancel Membership</button>
    </div>
</section>

      <section id="user-contract-section" class="section-card">
        <h3>My Sports Contract</h3>
        <div id="user-contract-display">
          <p style="color: gray; font-style: italic;">Connecting to League Office...</p>
        </div>
      </section>

      <section class="section-card" style="border: 2px solid #8e44ad;">
        <h3 style="color: #8e44ad;">üü£ BPS Token Shop</h3>
        <p>Spend your tokens on coupons!</p>
        <div id="bps-shop-items" style="display: flex; gap: 15px; flex-wrap: wrap;">
          <p>Loading tokens...</p>
        </div>
      </section>

      <section class="section-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h3>Shop</h3>
          <span id="active-discount-indicator" class="hidden" 
                style="background: #e74c3c; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 0.9em;">
            üî• Discount Active!
          </span>
        </div>
        <div id="shop-items"></div>
      </section>

      <section class="section-card" style="border: 2px solid #3498db;">
        <h3 style="color: #3498db;">üé® Cosmetics Shop</h3>
        <p>Customize your experience.</p>
        <div id="cosmetics-shop-items">
          <p>Loading cosmetics...</p>
        </div>
      </section>

      <section class="section-card">
        <h3>Inventory</h3>
        <p id="inventory-value">Total Value: $0</p>
        <div id="inventory-items">Loading...</div>
      </section>

      <section class="section-card">
        <h3>Transfer Money</h3>
        <div class="transfer-container">
            <input id="transfer-to" placeholder="Recipient Username" autocomplete="off">
            <input id="transfer-amount" type="number" placeholder="Amount">
            <button id="transfer-btn" class="btn-primary" type="button">Send</button>
        </div>
        <p id="transfer-message"></p>
      </section>

      <section class="section-card">
        <h3>Retirement Savings</h3>
        <p>Total Savings: $<span id="retirement-savings">0</span></p>
        <p id="retirement-interest">Interest (3%): $0.00</p>
        <p>Days until interest: <span id="retirement-days">0</span></p>
        <div class="retirement-actions">
          <input type="number" id="retirement-deposit" placeholder="Deposit Amount">
          <button id="retirement-deposit-btn" class="btn-primary" type="button">Deposit</button>
          <input type="number" id="retirement-withdraw" placeholder="Withdraw Amount">
          <button id="retirement-withdraw-btn" class="btn-secondary" type="button">Withdraw</button>
        </div>
        
        <div class="retirement-chart-container">
          <canvas id="retirementChart" style="width: 100%; max-height: 200px;"></canvas>
        </div>
        
        <p id="retirement-message" style="font-weight: bold; margin-top: 10px;"></p>
      </section>

      <section class="section-card" style="border: 2px solid #e67e22;">
        <h3 style="color: #e67e22;">üè¶ Loan Center</h3>
        <p>Credit Score: <strong id="display-credit-score">600</strong></p>
        
        <div id="loan-controls">
            <select id="loan-amount-select">
            <option value="50000" title="Requires Fair Status (0-499 Credit Score)">$50,000 (Fair+)</option>
            <option value="100000" title="Requires Good Status (500-649 Credit Score)">$100,000 (Good+)</option>
            <option value="500000" title="Requires Elite Status (650-749 Credit Score)">$500,000 (Elite+)</option>
            <option value="1000000" title="Requires Elite Status (750-850 Credit Score)">$1,000,000 (Elite+)</option>
          </select>
            <button id="take-loan-btn" class="btn-primary">Take Loan</button>
        </div>

        <div id="active-loan-info" class="hidden">
            <p>Current Debt: <span id="debt-amount">$0</span></p>
            <p>Daily Interest (5%): <span id="daily-interest">$0</span></p>
            <p id="interest-timer" style="font-size: 0.85em; color: #e67e22;">Next charge in: --:--:--</p>
            <p id="loan-due-date" style="font-size: 0.85em; margin-bottom: 10px;"></p>
            <button id="repay-loan-btn" class="btn-danger">Repay Loan</button>
        </div>
        <p id="loan-message" style="margin-top: 10px; font-weight: bold;"></p>
      </section>

      <section class="section-card compact-history">
        <div class="history-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div class="header-main" style="display: flex; align-items: center; gap: 8px;">
            <h3 style="margin: 0;">Transaction Activity</h3>
            <span id="history-count-badge" style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.75em; opacity: 0.8;">0 found</span>
          </div>
          <button id="clear-history-filters" class="btn-primary" style="height: 32px; padding: 0 16px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase;">Clear</button>
        </div>

        <div class="history-controls" style="display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.05); margin-bottom: 15px;">
          <div class="date-group" style="display: flex; gap: 10px;">
            <div class="input-wrapper" style="display: flex; flex-direction: column; gap: 4px;">
              <label style="font-size: 0.65rem; font-weight: 800; color: #888; letter-spacing: 0.5px;">FROM:</label>
              <input type="date" id="history-date-filter" style="background: #181818; border: 1px solid #222; color: #eee; padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; height: 38px;">
            </div>
            <div class="input-wrapper" style="display: flex; flex-direction: column; gap: 4px;">
              <label style="font-size: 0.65rem; font-weight: 800; color: #888; letter-spacing: 0.5px;">TO:</label>
              <input type="date" id="history-end-date-filter" style="background: #181818; border: 1px solid #222; color: #eee; padding: 6px 10px; border-radius: 8px; font-size: 0.85rem; height: 38px;">
            </div>
          </div>
          <div class="search-group" style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 0.65rem; font-weight: 800; color: #888; letter-spacing: 0.5px; opacity: 0;">SEARCH:</label>
            <input type="text" id="history-search-filter" placeholder="Search activity..." style="background: #181818; border: 1px solid #222; color: #eee; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; height: 38px; width: 100%;">
          </div>
        </div>

        <div id="unified-history-list" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
            <p style="color: gray; padding: 10px; text-align: center;">Loading activity...</p>
        </div>
      </section>
    </main>
  </div>

  <div id="admin-panel" class="screen hidden">
    <h2>Admin Panel</h2>
    <button id="back-to-dashboard" class="btn-secondary" type="button">Back</button>

    <h3>Add Shop Item</h3>
    <input id="new-item-name" placeholder="Item Name">
    <input id="new-item-price" type="number" placeholder="Price">
    <input id="new-item-image" placeholder="Image URL (optional)">
    <button id="add-item-btn" class="btn-primary" type="button">Add Item</button>

    <h3>Give Money</h3>
    <input id="admin-give-username" placeholder="Username" autocomplete="off">
    <input id="admin-give-amount" type="number" placeholder="Amount">
    <p><strong>User:</strong> <span id="admin-user-info" style="color: gray;">N/A</span></p>
    <button id="admin-give-btn" class="btn-danger" type="button">Give Money</button>

    <h3>Give BPS Tokens (Loyalty)</h3>
    <input id="admin-give-bps-username" placeholder="Username" autocomplete="off">
    <input id="admin-give-bps-amount" type="number" placeholder="BPS Amount">
    <p><strong>User:</strong> <span id="admin-bps-user-info" style="color: gray;">N/A</span></p>
    <button id="admin-give-bps-btn" class="btn-primary" type="button" style="background-color: #8e44ad;">Give BPS Tokens</button>

    <h3>Manage User Cosmetics</h3>
    <input id="admin-cosmetics-username" placeholder="Username" />
    <div id="admin-cosmetics-user-info">N/A</div>
    <div id="admin-cosmetics-list" style="margin-top:10px;"></div>

    <h3>Manage Employment Status</h3>
    <input id="admin-employment-username" placeholder="Username" autocomplete="off">
    <select id="admin-employment-status-select">
      <option value="Employed">Employed</option>
      <option value="Unemployed">Unemployed</option>
      <option value="Retired">Retired</option>
    </select>
    <button id="admin-set-employment-btn" class="btn-primary" type="button">Set Status</button>
    <p><strong>User:</strong> <span id="admin-employment-user-info" style="color: gray;">N/A</span></p>

    <div class="admin-section">
    <h3 style="color: #2ecc71;">üíé Membership & Trial Manager</h3>
    <p style="font-size: 0.85em; color: gray; margin-bottom: 10px;">Grant or Revoke membership tiers and trials.</p>
    
    <input id="admin-trial-username" placeholder="Target Username" class="admin-input-adaptive" autocomplete="off" style="margin-bottom: 10px;">
    <p id="admin-trial-user-info" style="color: gray; font-weight: bold; margin-bottom: 10px;">N/A</p>
    
    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <div style="flex: 2; display: flex; flex-direction: column; gap: 4px;">
            <label class="contract-label">SELECT PLAN</label>
            <select id="admin-trial-plan" class="admin-input-adaptive">
                <option value="basic">Basic Plan</option>
                <option value="premium">Premium Plan</option>
                <option value="platinum">Platinum Plan</option>
            </select>
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
            <label class="contract-label">DURATION</label>
            <input id="admin-trial-duration" type="number" placeholder="Qty" class="admin-input-adaptive">
        </div>
        <div style="flex: 1; display: flex; flex-direction: column; gap: 4px;">
            <label class="contract-label">UNIT</label>
            <select id="admin-trial-unit" class="admin-input-adaptive">
                <option value="days">Days</option>
                <option value="months">Months</option>
            </select>
        </div>
    </div>

    <div style="display: flex; gap: 10px;">
        <button id="admin-grant-trial-btn" class="btn-primary" style="flex: 2; background-color: #2ecc71; border-color: #27ae60;">
            Grant Membership / Trial
        </button>
        <button id="admin-revoke-trial-btn" class="btn-danger" style="flex: 1; font-size: 0.8em;">
            Revoke Current
        </button>
    </div>
</div>

    <div id="admin-request-actions" style="margin-top: 15px; border-top: 1px solid var(--contract-border); padding-top: 15px;">
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <div class="contract-inner-box" style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 8px;">
          </div>
        </div>
        <div class="contract-inner-box" style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; gap: 8px;">
          </div>
        </div>
      </div>
    </div>

    <div class="admin-section" style="border-top: 1px solid var(--contract-border); margin-top: 20px; padding-top: 20px;">
      <h3>üèÄ Sports Contract Office</h3>
      <p style="font-size: 0.85em; color: gray; margin-bottom: 10px;">Draft professional contracts and manage the league roster.</p>
      
      <input id="admin-contract-username" placeholder="Username" autocomplete="off">
      <p id="admin-contract-user-info" style="color: gray; font-weight: bold;">N/A</p>
      
      <div class="input-wrapper" style="margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px;">
        <label class="contract-label">TEAM NAME</label>
        <input id="contract-team" type="text" placeholder="e.g., Cincinnati Stars" class="admin-input-adaptive" style="border-radius: 8px; padding: 8px;">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
        <div class="input-wrapper" style="display: flex; flex-direction: column; gap: 4px;">
          <label class="contract-label">CONTRACT TERM (SEASONS)</label>
          <input id="contract-seasons" type="number" placeholder="e.g., 2" class="admin-input-adaptive" style="border-radius: 8px; padding: 8px;">
        </div>
        <div class="input-wrapper" style="display: flex; flex-direction: column; gap: 4px;">
          <label class="contract-label">SIGNING BONUS $</label>
          <input id="contract-signing-bonus" type="number" placeholder="Instantly paid" class="admin-input-adaptive" style="border-radius: 8px; padding: 8px;">
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
        <div class="input-wrapper" style="display: flex; flex-direction: column; gap: 4px;">
          <label class="contract-label">GUARANTEED (PER SEASON) $</label>
          <input id="contract-guaranteed" type="number" placeholder="Safety Net" class="admin-input-adaptive" style="border-radius: 8px; padding: 8px;">
        </div>
        <div class="input-wrapper" style="display: flex; flex-direction: column; gap: 4px;">
            <label class="contract-label">NON-GUARANTEED (PER SEASON) $</label>
            <input id="contract-non-guaranteed" type="number" placeholder="Performance Bonus" class="admin-input-adaptive" style="border-radius: 8px; padding: 8px;">
        </div>
      </div>

      <div class="input-wrapper" style="margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px;">
        <label class="contract-label">SEASON TOTAL POT (PER SEASON)</label>
        <div class="contract-inner-box">
          <input id="contract-base-cycle" type="text" placeholder="Auto-summed" readonly style="width: 100%; border: none; background: transparent; color: inherit; font-weight: bold; outline: none;">
        </div>
      </div>

      <div class="input-wrapper" style="margin-bottom: 15px; display: flex; flex-direction: column; gap: 4px;">
        <label class="contract-label">INCENTIVES & CONDUCT CLAUSES</label>
        <div class="contract-inner-box">
          <textarea id="contract-incentives" placeholder="e.g., Maintain 3.5 GPA, Keep room clean" style="width: 100%; border: none; background: transparent; color: inherit; font-family: inherit; min-height: 80px; outline: none;"></textarea>
        </div>
      </div>

      <button id="admin-offer-contract-btn" class="btn-primary" style="width: 100%;" disabled>Send Official Offer</button>

      <h4 style="margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 8px;">Active League Roster</h4>
      <p style="font-size: 0.75rem; color: #666; margin-bottom: 10px;">
        Manage players and payout installments (6 per season).
      </p>
      <div id="admin-active-contracts-list">
      </div>
    </div>

    <h3>Renewal Requests</h3>
    <div id="renewal-requests"></div>
  </div>

  <script type="module" src="firebaseConfig.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="shop.js"></script>
  <script type="module" src="dashboard.js"></script>
  <script type="module" src="transfer.js"></script>
  <script type="module" src="inventory.js"></script>
  <script type="module" src="bpsShop.js"></script>
  <script type="module" src="cosmetics.js"></script> 
  <script type="module" src="loan.js"></script> 
  <script type="module" src="contracts.js"></script>
  <script type="module" src="membership_plans.js"></script>
  </body>
</html>